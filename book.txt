-- Select data from the prep_book_dimension table
SELECT 
    book_sequence_id,
    book_id,
    book,
    dealer_inventory_system_book,
    book_trader_ubr9,
    book_ubr_faname,
    depth,
    Level,
    is_pseudo_group,
    last_update,
    CURRENT_DATE AS processed_date
FROM 
    strats_reportingdb.prep_book_dimension

UNION ALL

-- Select the latest records for each book_sequence_id
SELECT 
    book_sequence_id,
    argMax(book_id, processed_date) AS book_id,
    argMax(book, processed_date) AS book,
    argMax(dealer_inventory_system_book, processed_date) AS dealer_inventory_system_book,
    argMax(book_trader_ubr9, processed_date) AS book_trader_ubr9,
    argMax(book_ubr_faname, processed_date) AS book_ubr_faname,
    argMax(depth, processed_date) AS depth,
    argMax(Level, processed_date) AS Level,
    argMax(is_pseudo_group, processed_date) AS is_pseudo_group,
    argMax(last_update, processed_date) AS last_update,
    CURRENT_DATE AS processed_date
FROM 
    strats_reportingdb.book_dimension AS last_update
LEFT JOIN 
    strats_reportingdb.prep_book_dimension AS prep USING (book_sequence_id)
GROUP BY 
    book_sequence_id
